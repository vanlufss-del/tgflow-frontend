<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light dark">
    <title>–û–Ω–ª–∞–π–Ω –ó–∞–ø–∏—Å—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò –°–ë–†–û–° --- */
        :root {
            --bg-color: var(--tg-theme-bg-color, #f5f5f7); /* –ß—É—Ç—å —Ç–µ–º–Ω–µ–µ –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –∫–∞—Ä—Ç */
            --card-bg: var(--tg-theme-secondary-bg-color, #ffffff);
            --text-main: var(--tg-theme-text-color, #000000);
            --text-hint: var(--tg-theme-hint-color, #8e8e93);
            --accent: var(--tg-theme-button-color, #007aff);
            --accent-text: var(--tg-theme-button-text-color, #ffffff);
            --danger: #ff3b30;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
            --radius: 16px;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            padding: 0; 
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω—é—é –∫–Ω–æ–ø–∫—É */
        }

        h2 { 
            margin: 0 0 15px 0; 
            font-size: 28px; 
            font-weight: 800; 
            letter-spacing: -0.5px;
            padding: 0 4px;
        }

        .subtitle {
            font-size: 15px;
            color: var(--text-hint);
            margin-bottom: 20px;
            margin-top: -10px;
            padding: 0 4px;
        }

        /* --- –ö–û–ù–¢–ï–ô–ù–ï–†–´ –ò –ê–ù–ò–ú–ê–¶–ò–Ø --- */
        .container { 
            display: none; 
            padding: 20px;
            max-width: 600px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è –ü–ö */
            margin: 0 auto;
        }
        .container.active { 
            display: block; 
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideIn { 
            from { opacity: 0; transform: translateY(10px) scale(0.98); } 
            to { opacity: 1; transform: translateY(0) scale(1); } 
        }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø --- */
        .header-nav {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            color: var(--accent);
            font-weight: 500;
            font-size: 16px;
            transition: opacity 0.2s;
        }
        .header-nav:active { opacity: 0.6; }
        .header-nav svg { margin-right: 6px; width: 20px; height: 20px; }

        /* --- –ö–ê–†–¢–û–ß–ö–ò --- */
        .card { 
            background: var(--card-bg); 
            padding: 16px; 
            border-radius: var(--radius); 
            margin-bottom: 12px; 
            cursor: pointer; 
            box-shadow: var(--shadow);
            transition: transform 0.1s, box-shadow 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid transparent;
        }
        .card:active { 
            transform: scale(0.97); 
            box-shadow: none;
        }

        /* –ê–≤–∞—Ç–∞—Ä –º–∞—Å—Ç–µ—Ä–∞ (–∞–≤—Ç–æ-–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) */
        .avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF9A9E 0%, #FECFEF 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
            margin-right: 15px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            flex-shrink: 0; 
        }
        
        .card-content { flex: 1; }
        .card h3 { margin: 0; font-size: 17px; font-weight: 600; margin-bottom: 4px; }
        .card-desc { font-size: 13px; color: var(--text-hint); }
        .card-price { 
            font-weight: 700; 
            color: var(--accent); 
            background: rgba(0,122,255, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        .arrow-icon { color: var(--text-hint); opacity: 0.3; }

        /* --- –ö–ê–õ–ï–ù–î–ê–†–¨ --- */
        .date-input-wrapper {
            position: relative; 
            width: 100%; 
            height: 56px; 
            margin-top: 10px;
        }
        .date-fake-display {
            width: 100%; height: 100%; 
            background-color: var(--card-bg);
            border-radius: var(--radius); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 20px; box-sizing: border-box; 
            font-size: 17px; font-weight: 500;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }
        .date-fake-display.filled {
            border: 2px solid var(--accent);
            color: var(--accent);
            background-color: rgba(0,122,255, 0.03);
        }
        #date-picker {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            opacity: 0; cursor: pointer; z-index: 10; 
        }

        /* --- –°–õ–û–¢–´ –í–†–ï–ú–ï–ù–ò (–ö–∞–ø—Å—É–ª—ã) --- */
        .time-slots { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); /* 4 –≤ —Ä—è–¥ */
            gap: 10px; 
            margin-top: 25px; 
        }
        .time-slot { 
            background: var(--card-bg); 
            padding: 12px 5px; 
            text-align: center; 
            border-radius: 12px; 
            cursor: pointer; 
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .time-slot.selected { 
            background-color: var(--accent); 
            color: var(--accent-text); 
            box-shadow: 0 4px 10px rgba(0,122,255, 0.3);
            transform: translateY(-2px);
        }
        .no-slots-msg {
            text-align: center; margin-top: 40px; color: var(--text-hint);
            font-size: 16px; background: var(--card-bg); padding: 20px; 
            border-radius: var(--radius);
        }

        /* --- –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ –° –ö–ù–û–ü–ö–û–ô --- */
        .bottom-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--bg-color);
            padding: 15px 20px 30px 20px; /* –£—á–µ—Ç safe-area –Ω–∞ iPhone */
            border-top: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.8); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
            display: none;
            z-index: 100;
            animation: slideUp 0.3s;
        }
        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –±–∞—Ä–∞ */
        @media (prefers-color-scheme: dark) {
            .bottom-bar { background: rgba(30,30,30,0.8); }
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #custom-main-btn {
            width: 100%; 
            padding: 16px; 
            background-color: var(--accent); 
            color: var(--accent-text); 
            border: none;
            border-radius: 14px; 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,122,255, 0.3);
            transition: transform 0.1s;
        }
        #custom-main-btn:active { transform: scale(0.98); }
        
        .loading-text { 
            text-align: center; margin-top: 50px; 
            color: var(--text-hint); font-weight: 500; 
        }
        
        /* –ú–µ–¥–∏–∞ –∑–∞–ø—Ä–æ—Å –¥–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (min-width: 500px) {
            .time-slots { grid-template-columns: repeat(5, 1fr); }
        }
    </style>
</head>
<body>

    <div id="step0" class="container active">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</h2>
        <div class="subtitle">–ù–∞—à–∏ –ª—É—á—à–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –≥–æ—Ç–æ–≤—ã –ø—Ä–∏–Ω—è—Ç—å –≤–∞—Å</div>
        <div id="masters-list">
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <div id="step1" class="container">
        <div class="header-nav" onclick="goToStep(0)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            –ù–∞–∑–∞–¥ –∫ –º–∞—Å—Ç–µ—Ä–∞–º
        </div>
        <h2>–£—Å–ª—É–≥–∏</h2>
        <div class="subtitle">–ú–∞—Å—Ç–µ—Ä: <span id="master-name-display" style="color: var(--accent); font-weight:600;"></span></div>
        <div id="services-list"></div>
    </div>

    <div id="step2" class="container">
        <div class="header-nav" onclick="goToStep(1)">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            –ù–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º
        </div>
        <h2>–î–∞—Ç–∞ –∏ –í—Ä–µ–º—è</h2> 
        <div class="subtitle" id="selected-service-name"></div>
        
        <div class="date-input-wrapper">
            <div id="date-display" class="date-fake-display">
                <span>üóì –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</span>
                <span style="opacity:0.3">‚ñº</span>
            </div>
            <input type="date" id="date-picker" onchange="handleDateChange()" onclick="try{this.showPicker()}catch(e){}">
        </div>
        
        <div class="time-slots" id="time-slots" style="display:none;"></div>
        
        <div id="no-slots-msg" class="no-slots-msg" style="display:none;">
            üòî –ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
        </div>
    </div>

    <div class="bottom-bar" id="bottom-bar">
        <button id="custom-main-btn" onclick="sendData()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide(); 

        let allData = { masters: [] };
        let selection = { masterId: null, service: null, price: null, date: null, time: null };

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ü–≤–µ—Ç–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏ (–µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ)
        const gradients = [
            "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)",
            "linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)",
            "linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)",
            "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)"
        ];

        function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataRaw = urlParams.get('data');
            const listContainer = document.getElementById('masters-list');
            
            if (dataRaw) {
                try { 
                    allData = JSON.parse(decodeURIComponent(dataRaw));
                    renderMasters();
                } catch (e) { 
                    listContainer.innerHTML = '<p style="text-align:center;">–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö</p>';
                }
            } else {
                listContainer.innerHTML = '<p style="text-align:center;">–î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã</p>';
            }
        }
        loadData();

        function renderMasters() {
            const list = document.getElementById('masters-list');
            list.innerHTML = '';

            if (!allData.masters || allData.masters.length === 0) {
                list.innerHTML = '<p style="text-align:center;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤</p>';
                return;
            }

            allData.masters.forEach((master, index) => {
                const div = document.createElement('div');
                div.className = 'card';
                
                // –õ–û–ì–ò–ö–ê –ê–í–ê–¢–ê–†–ö–ò
                let avatarHtml = '';
                
                if (master.photo) {
                    avatarHtml = `<div class="avatar" style="background-image: url('${master.photo}');"></div>`;
                } else {
                    const firstLetter = master.name.charAt(0).toUpperCase();
                    const bg = gradients[index % gradients.length];
                    avatarHtml = `<div class="avatar" style="background:${bg}">${firstLetter}</div>`;
                }

                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        ${avatarHtml}
                        <div class="card-content">
                            <h3>${master.name}</h3>
                            <div class="card-desc">–î–æ—Å—Ç—É–ø–Ω–æ —É—Å–ª—É–≥: ${master.services.length}</div>
                        </div>
                    </div>
                    <div class="arrow-icon">‚ùØ</div>
                `;
                div.onclick = () => selectMaster(master);
                list.appendChild(div);
            });
        }

        function selectMaster(master) {
            selection.masterId = master.id;
            document.getElementById('master-name-display').innerText = master.name;
            renderServices(master);
            goToStep(1); 
        }

        function renderServices(master) {
            const list = document.getElementById('services-list');
            list.innerHTML = '';

            if (!master.services || master.services.length === 0) {
                list.innerHTML = '<p style="text-align:center;">–ù–µ—Ç —É—Å–ª—É–≥</p>';
                return;
            }

            master.services.forEach(s => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-content">
                        <h3>${s.name}</h3>
                    </div>
                    <div class="card-price">${s.price} ‚ÇΩ</div>
                `;
                div.onclick = () => selectService(s.name, s.price);
                list.appendChild(div);
            });
        }

        function selectService(name, price) {
            selection.service = name;
            selection.price = price;
            document.getElementById('selected-service-name').innerText = `–í—ã–±—Ä–∞–Ω–æ: ${name} (${price} ‚ÇΩ)`;
            resetCalendar();
            goToStep(2); 
        }

        function resetCalendar() {
            document.getElementById('date-picker').value = '';
            const display = document.getElementById('date-display');
            display.innerHTML = '<span>üóì –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É</span><span style="opacity:0.3">‚ñº</span>';
            display.classList.remove('filled');
            document.getElementById('time-slots').style.display = 'none';
            document.getElementById('no-slots-msg').style.display = 'none';
            document.getElementById('bottom-bar').style.display = 'none';
        }

        function handleDateChange() {
            const dateInput = document.getElementById('date-picker');
            const displayDiv = document.getElementById('date-display');
            const dateVal = dateInput.value;
            
            if(dateVal) {
                const dateObj = new Date(dateVal);
                const options = { day: 'numeric', month: 'long', weekday: 'short' };
                const dateStr = dateObj.toLocaleDateString('ru-RU', options);
                
                displayDiv.innerHTML = `<span style="font-weight:600; color:var(--accent)">${dateStr}</span>`;
                displayDiv.classList.add('filled'); 
                renderTimeSlots(dateVal); 
            }
        }

        function renderTimeSlots(dateVal) {
            const container = document.getElementById('time-slots');
            const msgDiv = document.getElementById('no-slots-msg');
            const bar = document.getElementById('bottom-bar');
            
            container.innerHTML = ''; 
            container.style.display = 'none';
            msgDiv.style.display = 'none';
            bar.style.display = 'none';
            
            selection.date = dateVal;

            const currentMaster = allData.masters.find(m => m.id === selection.masterId);
            if (!currentMaster) return;

            let slotsToShow = currentMaster.slots || []; 
            if (currentMaster.specials && currentMaster.specials.hasOwnProperty(dateVal)) {
                slotsToShow = currentMaster.specials[dateVal];
            }

            const busyTimes = (currentMaster.busy && currentMaster.busy[dateVal]) ? currentMaster.busy[dateVal] : [];

            // –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ó–ê–ù–Ø–¢–´–•
            const freeSlots = slotsToShow.filter(time => {
                return !busyTimes.some(busy => busy.trim() === time.trim());
            });

            if (freeSlots.length === 0) {
                msgDiv.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            
            freeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.innerText = time;
                slot.onclick = () => selectTime(time, slot);
                container.appendChild(slot);
            });
        }

        function selectTime(time, element) {
            selection.time = time;
            
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            
            const bar = document.getElementById('bottom-bar');
            const btn = document.getElementById('custom-main-btn');
            
            bar.style.display = 'block';
            btn.innerText = `–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ ${time}`;
            
            if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
        }

        function goToStep(stepNumber) {
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            document.getElementById('step' + stepNumber).classList.add('active');
            
            if (stepNumber < 2) {
                document.getElementById('bottom-bar').style.display = 'none';
            }

            if (stepNumber === 0) tg.BackButton.hide();
            else {
                tg.BackButton.show();
                tg.BackButton.onClick(() => goToStep(stepNumber - 1));
            }
        }

        function sendData() {
            const btn = document.getElementById('custom-main-btn');
            btn.innerText = "‚è≥ –û—Ñ–æ—Ä–º–ª—è–µ–º...";
            btn.style.opacity = "0.7";
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
            tg.sendData(JSON.stringify(selection)); 
        }
    </script>
</body>
</html>
