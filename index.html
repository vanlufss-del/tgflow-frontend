<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="color-scheme" content="light dark">
    <title>–û–Ω–ª–∞–π–Ω –ó–∞–ø–∏—Å—å</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* --- –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò --- */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            padding: 20px; 
            margin: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–æ–≤ */
        .container { 
            display: none; 
            animation: fadeIn 0.3s ease-in-out; 
        }
        .container.active { 
            display: block; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        h2 { 
            margin-top: 0; 
            margin-bottom: 20px; 
            font-size: 22px; 
            font-weight: 700; 
        }

        /* –ö–Ω–æ–ø–∫–∞ –ù–ê–ó–ê–î */
        .back-btn {
            color: var(--tg-theme-link-color, #3390ec);
            font-size: 16px;
            margin-bottom: 15px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            font-weight: 500;
        }
        .back-btn:active { opacity: 0.6; }
        
        /* –ö–ê–†–¢–û–ß–ö–ò (–ú–∞—Å—Ç–µ—Ä–∞ –∏ –£—Å–ª—É–≥–∏) */
        .card { 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            padding: 16px; 
            border-radius: 14px; 
            margin-bottom: 12px; 
            cursor: pointer; 
            border: 2px solid transparent; 
            transition: transform 0.1s, background-color 0.1s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card:active { 
            transform: scale(0.98); 
            background-color: var(--tg-theme-hint-color, #e0e0e0);
        }
        .card h3 { margin: 0; font-size: 17px; font-weight: 600; }
        .card p { margin: 5px 0 0 0; opacity: 0.7; font-size: 14px; }
        .card-price { font-weight: 600; color: var(--tg-theme-button-color, #3390ec); }

        /* --- –ö–ê–õ–ï–ù–î–ê–†–¨ (FIX –î–õ–Ø iPHONE) --- */
        .date-input-wrapper {
            position: relative; 
            width: 100%; 
            height: 55px; 
            margin-top: 15px;
        }

        /* –í–∏–¥–∏–º–∞—è —á–∞—Å—Ç—å (–ö—Ä–∞—Å–∏–≤–∞—è –∫–Ω–æ–ø–∫–∞) */
        .date-fake-display {
            width: 100%; 
            height: 100%; 
            background-color: var(--tg-theme-secondary-bg-color, #efeff3);
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 15px; 
            box-sizing: border-box; 
            color: var(--tg-theme-text-color, #000); 
            font-size: 17px; 
            border: 1px solid transparent;
            font-weight: 500;
        }
        
        /* –ö–æ–≥–¥–∞ –¥–∞—Ç–∞ –≤—ã–±—Ä–∞–Ω–∞ */
        .date-fake-display.filled {
            border-color: var(--tg-theme-button-color, #3390ec);
            font-weight: 600;
            color: var(--tg-theme-button-color, #3390ec);
        }

        /* –ù–µ–≤–∏–¥–∏–º—ã–π –Ω–∞—Å—Ç–æ—è—â–∏–π –∏–Ω–ø—É—Ç */
        #date-picker {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            cursor: pointer; 
            z-index: 10; 
        }

        /* --- –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ô –°–¢–ò–õ–¨ –î–õ–Ø –ü–ö (Telegram Desktop) --- */
        @media (hover: hover) and (pointer: fine) {
            .date-fake-display { display: none; }
            #date-picker {
                position: relative; 
                opacity: 1; 
                width: 100%;
                background-color: var(--tg-theme-secondary-bg-color, #efeff3);
                color: var(--tg-theme-text-color, #000);
                padding: 12px; 
                border-radius: 12px; 
                border: 1px solid var(--tg-theme-hint-color, #ccc);
                font-size: 16px;
                box-sizing: border-box;
                z-index: 1;
            }
        }

        /* –°–ï–¢–ö–ê –í–†–ï–ú–ï–ù–ò */
        .time-slots { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* 3 –∫–æ–ª–æ–Ω–∫–∏ */
            gap: 10px; 
            margin-top: 25px; 
        }
        
        .time-slot { 
            background: var(--tg-theme-secondary-bg-color, #f0f0f0); 
            padding: 12px; 
            text-align: center; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 500;
            transition: background-color 0.1s;
        }
        
        .time-slot.selected { 
            background-color: var(--tg-theme-button-color, #3390ec); 
            color: var(--tg-theme-button-text-color, #ffffff); 
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏–µ "–ù–µ—Ç –∑–∞–ø–∏—Å–∏" */
        .no-slots-msg {
            text-align: center;
            margin-top: 30px;
            color: var(--tg-theme-hint-color, #888);
            font-style: italic;
            font-size: 16px;
        }

        /* –ì–õ–ê–í–ù–ê–Ø –ö–ù–û–ü–ö–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø */
        #custom-main-btn {
            display: none; 
            width: 100%; 
            padding: 16px; 
            margin-top: 30px;
            background-color: var(--tg-theme-button-color, #3390ec); 
            color: var(--tg-theme-button-text-color, #ffffff); 
            border: none;
            border-radius: 12px; 
            font-size: 17px; 
            font-weight: 600; 
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #custom-main-btn:active { opacity: 0.8; transform: translateY(1px); }
        
        .loading-text { text-align: center; margin-top: 50px; opacity: 0.5; }
    </style>
</head>
<body>

    <div id="step0" class="container active">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞</h2>
        <div id="masters-list">
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <div id="step1" class="container">
        <div class="back-btn" onclick="goToStep(0)">‚¨Ö –ù–∞–∑–∞–¥ –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º</div>
        <h2>–£—Å–ª—É–≥–∏: <span id="master-name-display" style="color: var(--tg-theme-button-color);"></span></h2>
        <div id="services-list"></div>
    </div>

    <div id="step2" class="container">
        <div class="back-btn" onclick="goToStep(1)">‚¨Ö –ù–∞–∑–∞–¥ –∫ —É—Å–ª—É–≥–∞–º</div>
        <h2>–î–∞—Ç–∞ –∏ –í—Ä–µ–º—è</h2> 
        <p style="opacity: 0.7; margin-bottom: 5px;">–í—ã–±—Ä–∞–Ω–∞ —É—Å–ª—É–≥–∞:</p>
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 20px;" id="selected-service-name"></div>
        
        <div class="date-input-wrapper">
            <div id="date-display" class="date-fake-display">
                üìÖ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É
            </div>
            <input type="date" id="date-picker" onchange="handleDateChange()">
        </div>
        
        <div class="time-slots" id="time-slots" style="display:none;"></div>
        
        <div id="no-slots-msg" class="no-slots-msg" style="display:none;">
            –í —ç—Ç–æ—Ç –¥–µ–Ω—å –∑–∞–ø–∏—Å–∏ –Ω–µ—Ç (–∏–ª–∏ –≤—Å—ë –∑–∞–Ω—è—Ç–æ)
        </div>

        <button id="custom-main-btn" onclick="sendData()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –ó–ê–ü–ò–°–¨</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide(); 

        // –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        let allData = { masters: [] };
        
        // –û–±—ä–µ–∫—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—ã–±–æ—Ä–∞
        let selection = {
            masterId: null,
            service: null,
            price: null,
            date: null,
            time: null
        };

        // --- 1. –ó–ê–ì–†–£–ó–ö–ê –ò –ü–ê–†–°–ò–ù–ì –î–ê–ù–ù–´–• ---
        function loadData() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataRaw = urlParams.get('data');
            const listContainer = document.getElementById('masters-list');
            
            if (dataRaw) {
                try { 
                    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JSON, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª –±–æ—Ç
                    allData = JSON.parse(decodeURIComponent(dataRaw));
                    renderMasters();
                } catch (e) { 
                    console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", e); 
                    listContainer.innerHTML = '<p style="text-align:center; color:red;">–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
                }
            } else {
                listContainer.innerHTML = '<p style="text-align:center; opacity:0.5">–î–∞–Ω–Ω—ã–µ –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞.</p>';
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadData();

        // --- 2. –†–ï–ù–î–ï–† –°–ü–ò–°–ö–ê –ú–ê–°–¢–ï–†–û–í (–®–∞–≥ 0) ---
        function renderMasters() {
            const list = document.getElementById('masters-list');
            list.innerHTML = '';

            if (!allData.masters || allData.masters.length === 0) {
                list.innerHTML = '<p style="text-align:center; opacity:0.5; margin-top:20px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤</p>';
                return;
            }

            allData.masters.forEach(master => {
                const div = document.createElement('div');
                div.className = 'card';
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                div.innerHTML = `
                    <div style="display:flex; align-items:center;">
                        <span style="font-size:24px; margin-right:10px;">üë§</span>
                        <h3>${master.name}</h3>
                    </div>
                    <span style="opacity:0.5;">‚ùØ</span>
                `;
                div.onclick = () => selectMaster(master);
                list.appendChild(div);
            });
        }

        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –º–∞—Å—Ç–µ—Ä–∞
        function selectMaster(master) {
            selection.masterId = master.id;
            document.getElementById('master-name-display').innerText = master.name;
            renderServices(master);
            goToStep(1); // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç–∫—Ä–∞–Ω
        }

        // --- 3. –†–ï–ù–î–ï–† –£–°–õ–£–ì (–®–∞–≥ 1) ---
        function renderServices(master) {
            const list = document.getElementById('services-list');
            list.innerHTML = '';

            if (!master.services || master.services.length === 0) {
                list.innerHTML = '<p style="text-align:center; opacity:0.5; margin-top:20px;">–£ —ç—Ç–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –ø–æ–∫–∞ –Ω–µ—Ç —É—Å–ª—É–≥</p>';
                return;
            }

            master.services.forEach(s => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div>
                        <h3>${s.name}</h3>
                    </div>
                    <div class="card-price">${s.price} ‚ÇΩ</div>
                `;
                div.onclick = () => selectService(s.name, s.price);
                list.appendChild(div);
            });
        }

        // –õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏
        function selectService(name, price) {
            selection.service = name;
            selection.price = price;
            document.getElementById('selected-service-name').innerText = `${name} (${price} ‚ÇΩ)`;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ –¥–∞—Ç—ã –ø—Ä–∏ –Ω–æ–≤–æ–º –≤—ã–±–æ—Ä–µ
            resetCalendar();
            
            goToStep(2); // –ü–µ—Ä–µ—Ö–æ–¥ –∫ –∫–∞–ª–µ–Ω–¥–∞—Ä—é
        }

        function resetCalendar() {
            document.getElementById('date-picker').value = '';
            const display = document.getElementById('date-display');
            display.innerText = 'üìÖ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É';
            display.classList.remove('filled');
            document.getElementById('time-slots').style.display = 'none';
            document.getElementById('no-slots-msg').style.display = 'none';
            document.getElementById('custom-main-btn').style.display = 'none';
        }

        // --- 4. –ö–ê–õ–ï–ù–î–ê–†–¨ –ò –í–†–ï–ú–Ø (–®–∞–≥ 2) ---
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –≤ –∏–Ω–ø—É—Ç–µ
        function handleDateChange() {
            const dateInput = document.getElementById('date-picker');
            const displayDiv = document.getElementById('date-display');
            
            const dateVal = dateInput.value;
            
            if(dateVal) {
                // –ö—Ä–∞—Å–∏–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã
                const dateObj = new Date(dateVal);
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                const dateStr = dateObj.toLocaleDateString('ru-RU', options);
                
                displayDiv.innerText = "üóì " + dateStr;
                displayDiv.classList.add('filled'); 
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏
                renderTimeSlots(dateVal); 
            }
        }

        // --- –ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê: –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –¢–û–õ–¨–ö–û –°–í–û–ë–û–î–ù–´–• –°–õ–û–¢–û–í ---
        function renderTimeSlots(dateVal) {
            const container = document.getElementById('time-slots');
            const msgDiv = document.getElementById('no-slots-msg');
            const btn = document.getElementById('custom-main-btn');
            
            // –û—á–∏—Å—Ç–∫–∞
            container.innerHTML = ''; 
            container.style.display = 'none';
            msgDiv.style.display = 'none';
            btn.style.display = 'none';
            
            selection.date = dateVal;

            // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞—Å—Ç–µ—Ä–∞ –≤ –±–∞–∑–µ
            const currentMaster = allData.masters.find(m => m.id === selection.masterId);
            
            if (!currentMaster) return;

            // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–ª–æ—Ç—ã (–û–±—ã—á–Ω—ã–µ –∏–ª–∏ –°–ø–µ—Ü)
            let slotsToShow = currentMaster.slots || []; 
            
            // –ï—Å–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –µ—Å—Ç—å –∑–∞–ø–∏—Å—å –≤ specials (–∏—Å–∫–ª—é—á–µ–Ω–∏—è)
            if (currentMaster.specials && currentMaster.specials.hasOwnProperty(dateVal)) {
                slotsToShow = currentMaster.specials[dateVal];
            }

            // 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ó–ê–ù–Ø–¢–û–ì–û –≤—Ä–µ–º–µ–Ω–∏
            const busyTimes = (currentMaster.busy && currentMaster.busy[dateVal]) ? currentMaster.busy[dateVal] : [];

            // 3. –§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ —Å–ª–æ—Ç—ã, –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –≤ —Å–ø–∏—Å–∫–µ –∑–∞–Ω—è—Ç—ã—Ö
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º trim(), —á—Ç–æ–±—ã "10:00 " (—Å –ø—Ä–æ–±–µ–ª–æ–º) —Å—á–∏—Ç–∞–ª–æ—Å—å —Ä–∞–≤–Ω—ã–º "10:00"
            const freeSlots = slotsToShow.filter(time => {
                return !busyTimes.some(busy => busy.trim() === time.trim());
            });

            // –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å —Å–≤–æ–±–æ–¥–Ω—ã—Ö —Å–ª–æ—Ç–æ–≤ -> –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (freeSlots.length === 0) {
                msgDiv.style.display = 'block';
                return;
            }

            // --- –û–¢–†–ò–°–û–í–ö–ê –ö–ù–û–ü–û–ö ---
            container.style.display = 'grid';
            
            // –†–∏—Å—É–µ–º –¢–û–õ–¨–ö–û —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å–ª–æ—Ç—ã
            freeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.innerText = time;
                
                // –°—Ä–∞–∑—É –≤–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞, —Ç–∞–∫ –∫–∞–∫ –∑–∞–Ω—è—Ç—ã—Ö —Ç—É—Ç –Ω–µ—Ç
                slot.onclick = () => selectTime(time, slot);
                
                container.appendChild(slot);
            });
        }

        // –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function selectTime(time, element) {
            // –ë–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å classList.contains('disabled'), —Ç.–∫. —Ç–∞–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ –Ω–µ—Ç
            selection.time = time;
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            const btn = document.getElementById('custom-main-btn');
            btn.style.display = 'block';
            btn.innerText = `–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å: ${selection.date} –≤ ${time}`;
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function goToStep(stepNumber) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —ç–∫—Ä–∞–Ω—ã
            document.querySelectorAll('.container').forEach(el => el.classList.remove('active'));
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π
            document.getElementById('step' + stepNumber).classList.add('active');
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–æ–π "–ù–∞–∑–∞–¥" –≤ —Å–∞–º–æ–º –¢–µ–ª–µ–≥—Ä–∞–º–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            if (stepNumber === 0) {
                tg.BackButton.hide();
            } else {
                tg.BackButton.show();
                tg.BackButton.onClick(() => {
                    goToStep(stepNumber - 1);
                });
            }
        }

        // --- –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ë–û–¢–£ ---
        function sendData() {
            const btn = document.getElementById('custom-main-btn');
            btn.innerText = "‚è≥ –û—Ñ–æ—Ä–º–ª—è–µ–º...";
            btn.style.opacity = "0.7";
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –±–æ—Ç
            tg.sendData(JSON.stringify(selection)); 
        }
    </script>
</body>
</html>
